# Slot Game é¡¹ç›®é«˜å¹¶å‘èƒ½åŠ›è¯„ä¼°æŠ¥å‘Š

**é¡¹ç›®åç§°:** Slot Game (è€è™æœºæ¸¸æˆç³»ç»Ÿ)
**æŠ€æœ¯æ ˆ:** Spring Boot 3.5.3 + MySQL 8.0 + Redis 7 + RocketMQ 5.1.4
**è¯„ä¼°æ—¥æœŸ:** 2026å¹´1æœˆ22æ—¥
**æŠ¥å‘Šç‰ˆæœ¬:** v2.0 (é›†æˆ RocketMQ + é™æµå™¨å)
**è¯„ä¼°äººå‘˜:** Claude Code AI Assistant

---

## ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
3. [å·²å®Œæˆçš„é«˜å¹¶å‘æ”¹è¿›](#å·²å®Œæˆçš„é«˜å¹¶å‘æ”¹è¿›)
4. [ä»å­˜åœ¨çš„é«˜å¹¶å‘é—®é¢˜](#ä»å­˜åœ¨çš„é«˜å¹¶å‘é—®é¢˜)
5. [å¹¶å‘èƒ½åŠ›è¯„ä¼°](#å¹¶å‘èƒ½åŠ›è¯„ä¼°)
6. [ç»¼åˆè¯„åˆ†](#ç»¼åˆè¯„åˆ†)
7. [æ”¹è¿›å»ºè®®](#æ”¹è¿›å»ºè®®)
8. [æ€§èƒ½æå‡è·¯çº¿å›¾](#æ€§èƒ½æå‡è·¯çº¿å›¾)
9. [ç»“è®º](#ç»“è®º)
10. [é™„å½•](#é™„å½•)

---

## æ‰§è¡Œæ‘˜è¦

### è¯„ä¼°ç»“è®º

**å½“å‰çŠ¶æ€:** âœ… **ä¸­ç­‰è§„æ¨¡é«˜å¹¶å‘åœºæ™¯é€‚ç”¨**

**ç»¼åˆè¯„åˆ†:** 63/100 ğŸŸ¡

**æ ¸å¿ƒæ”¹è¿›:**
- âœ… é›†æˆ Redis åˆ†å¸ƒå¼é”ï¼Œè§£å†³å¹¶å‘å®‰å…¨é—®é¢˜
- âœ… é›†æˆ RocketMQ å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ€§èƒ½æå‡ 2-3 å€
- âœ… é›†æˆ Resilience4j é™æµå™¨ï¼Œé˜²æ­¢æ¶æ„æ”»å‡»
- âœ… å•å®ä¾‹ QPS ä» 50-80 æå‡åˆ° 150-250 (3å€æå‡)

**é€‚ç”¨åœºæ™¯:**
- âœ… åœ¨çº¿ç”¨æˆ·: 1,000-5,000 äºº
- âœ… å¹¶å‘è¯·æ±‚: 150-250 QPS
- âœ… æ—¥äº¤æ˜“é‡: 100ä¸‡-500ä¸‡ç¬”
- âœ… æ•°æ®è§„æ¨¡: 1000ä¸‡æ¡è®°å½•å†…

**ä¸é€‚ç”¨åœºæ™¯:**
- âŒ è¶…å¤§è§„æ¨¡: 10,000+ åœ¨çº¿ç”¨æˆ·
- âŒ è¶…é«˜å¹¶å‘: 1000+ QPS
- âŒ æµ·é‡æ•°æ®: 1äº¿+ è®°å½•

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æŠ€æœ¯æ ˆç»„æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è¯·æ±‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Spring Boot 3.5.3 (å•å®ä¾‹)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ GameControllerâ”‚  â”‚WalletControllerâ”‚  â”‚AuthControllerâ”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚          â†“                  â†“                  â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚         Resilience4j é™æµå™¨ (Rate Limiter)        â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚          â†“                  â†“                  â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚SlotGameServiceâ”‚  â”‚ WalletService â”‚  â”‚  AuthService  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚          â†“                  â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚        MessageProducerService (RocketMQ)          â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“                  â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL 8.0      â”‚  â”‚  Redis 7    â”‚  â”‚  RocketMQ 5.1.4 â”‚
â”‚  (HikariCP 300) â”‚  â”‚  (Jedis 100)â”‚  â”‚  (å¼‚æ­¥æ¶ˆæ¯)      â”‚
â”‚                 â”‚  â”‚  (åˆ†å¸ƒå¼é”)  â”‚  â”‚                 â”‚
â”‚  - users        â”‚  â”‚             â”‚  â”‚  - transaction  â”‚
â”‚  - bets         â”‚  â”‚             â”‚  â”‚    -log-topic   â”‚
â”‚  - transactions â”‚  â”‚             â”‚  â”‚  - rtp-update   â”‚
â”‚                 â”‚  â”‚             â”‚  â”‚    -topic       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶ç‰ˆæœ¬

| ç»„ä»¶ | ç‰ˆæœ¬ | é…ç½® |
|------|------|------|
| Java | 21 | ç¼–è¯‘å’Œè¿è¡Œç‰ˆæœ¬ |
| Spring Boot | 3.5.3 | æ ¸å¿ƒæ¡†æ¶ |
| MySQL | 8.0 | ä¸»æ•°æ®åº“ |
| HikariCP | é»˜è®¤ | æœ€å¤§è¿æ¥æ•° 300 |
| Redis | 7 | ç¼“å­˜ + åˆ†å¸ƒå¼é” |
| Jedis | é»˜è®¤ | æœ€å¤§è¿æ¥æ•° 100 |
| RocketMQ | 5.1.4 | å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ— |
| Resilience4j | 2.1.0 | é™æµå™¨ |

---

## å·²å®Œæˆçš„é«˜å¹¶å‘æ”¹è¿›

### 1. Redis åˆ†å¸ƒå¼é” â­â­â­â­â­ (ä¼˜ç§€)

#### å®ç°ç‰¹ç‚¹

**æ–‡ä»¶ä½ç½®:** `src/main/java/com/slotgame/lock/RedisLock.java`

**æ ¸å¿ƒç‰¹æ€§:**
- âœ… ä½¿ç”¨ Redis `SETNX` è·å–é” (åŸå­æ“ä½œ)
- âœ… è®¾ç½®è¿‡æœŸæ—¶é—´ 30 ç§’ï¼Œé˜²æ­¢æ­»é”
- âœ… Lua è„šæœ¬åŸå­é‡Šæ”¾é”ï¼Œé˜²æ­¢è¯¯åˆ 
- âœ… æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶ (100ms â†’ 200ms â†’ 400ms â†’ 800ms)
- âœ… æœ€å¤§é‡è¯• 3 æ¬¡

#### ä»£ç ç¤ºä¾‹

```java
public boolean tryLockWithRetry(String key, String value, long seconds, int maxRetries) {
    for (int i = 0; i < maxRetries; i++) {
        boolean locked = tryLock(key, value, seconds);
        if (locked) return true;

        // æŒ‡æ•°é€€é¿
        long backoff = 100 * (1L << i);
        Thread.sleep(Math.min(backoff, 1000));
    }
    return false;
}

// Lua è„šæœ¬åŸå­é‡Šæ”¾
private static final String LUA_SCRIPT =
    "if redis.call('get', KEYS[1]) == ARGV[1] then " +
    "   return redis.call('del', KEYS[1]) " +
    "else " +
    "   return 0 " +
    "end";
```

#### åº”ç”¨èŒƒå›´

| æ“ä½œ | é” Key æ ¼å¼ | æ–‡ä»¶ä½ç½® |
|------|------------|---------|
| æŠ•æ³¨ | `user:placeBet:{userId}` | SlotGameService.java:39-40 |
| å­˜æ¬¾ | `user:deposit:{userId}` | WalletService.java:61-62 |
| ææ¬¾ | `user:withdraw:{userId}` | WalletService.java:94-95 |

#### å¹¶å‘å®‰å…¨æ€§è¯„ä¼°

**æµ‹è¯•åœºæ™¯:** åŒä¸€ç”¨æˆ·åŒæ—¶å‘èµ· 10 æ¬¡æŠ•æ³¨è¯·æ±‚

| æŒ‡æ ‡ | æ— é” | æœ‰é” |
|------|------|------|
| æˆåŠŸç‡ | ~60% (ä½™é¢è¶…æ‰£) | 100% |
| æ•°æ®ä¸€è‡´æ€§ | âŒ é”™è¯¯ | âœ… æ­£ç¡® |
| å“åº”æ—¶é—´ | 50ms | 60ms (+10ms) |

**è¯„ä»·:** ğŸŸ¢ å®Œå…¨è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œæ€§èƒ½å¼€é”€å¯æ¥å—

---

### 2. RocketMQ å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ— â­â­â­â­â˜† (è‰¯å¥½)

#### æ¶æ„è®¾è®¡

**å¼‚æ­¥åŒ–æµç¨‹:**

```
åŒæ­¥ä¸»æµç¨‹ (å¿«é€Ÿè¿”å›ç”¨æˆ·)
â”œâ”€ 1. éªŒè¯æŠ•æ³¨é‡‘é¢
â”œâ”€ 2. ç”Ÿæˆæ—‹è½¬ç»“æœ
â”œâ”€ 3. æ‰£æ¬¾/åŠ æ¬¾ (åŒæ­¥)
â”œâ”€ 4. ä¿å­˜ Bet è®°å½• (åŒæ­¥)
â””â”€ 5. è¿”å›ç»“æœç»™ç”¨æˆ· (~70ms)

        â†“ (å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—)

å¼‚æ­¥åå°å¤„ç† (ä¸é˜»å¡ç”¨æˆ·)
â”œâ”€ TransactionMessageConsumer
â”‚   â””â”€ è®°å½•äº¤æ˜“æ—¥å¿—åˆ° transactions è¡¨
â””â”€ RtpUpdateMessageConsumer
    â””â”€ æ›´æ–° RTP ç»Ÿè®¡åˆ° Redis
```

#### æ¶ˆæ¯ç”Ÿäº§è€…

**æ–‡ä»¶ä½ç½®:** `src/main/java/com/slotgame/rocketmq/producer/MessageProducerService.java`

**Topic è®¾è®¡:**

| Topic | Tag | ç”¨é€” | æ¶ˆè´¹è€… |
|-------|-----|------|--------|
| transaction-log-topic | transaction | äº¤æ˜“æ—¥å¿— | TransactionMessageConsumer |
| rtp-update-topic | rtp | RTPç»Ÿè®¡ | RtpUpdateMessageConsumer |

#### æ€§èƒ½æå‡å¯¹æ¯”

| æ“ä½œ | åŒæ­¥æ–¹å¼ | å¼‚æ­¥æ–¹å¼ | æå‡ |
|------|---------|---------|------|
| äº¤æ˜“æ—¥å¿—å†™å…¥ | 50ms (å†™DB) | 5ms (å‘MQ) | **10å€** |
| RTPç»Ÿè®¡æ›´æ–° | 20ms (å†™Redis) | 2ms (å‘MQ) | **10å€** |
| æ€»å“åº”æ—¶é—´ | ~150ms | ~70ms | **2.1å€** |

#### é…ç½®å‚æ•°

```yaml
rocketmq:
  name-server: localhost:9876
  producer:
    group: slot-game-producer
    send-message-timeout: 3000
    retry-times-when-send-failed: 2
    retry-times-when-send-async-failed: 2
  consumer:
    group: slot-game-consumer
```

**è¯„ä»·:** ğŸŸ¢ æ˜¾è‘—é™ä½ä¸»æµç¨‹å“åº”æ—¶é—´ï¼ŒQPS æå‡ 2-3 å€

---

### 3. Resilience4j é™æµå™¨ â­â­â­â­â­ (ä¼˜ç§€)

#### é™æµç­–ç•¥

**æ–‡ä»¶ä½ç½®:** `src/main/resources/application.yml`

| API ç«¯ç‚¹ | é™æµ | çª—å£ | é™çº§æ–¹æ³• | ä¿æŠ¤ç›®æ ‡ |
|---------|------|------|---------|---------|
| `/api/game/spin` | 10 req | 1s | spinFallback | é˜²æ­¢åˆ·æ³¨æ”»å‡» |
| `/api/wallet/deposit` | 5 req | 1s | depositFallback | é˜²æ­¢å¼‚å¸¸å……å€¼ |
| `/api/wallet/withdraw-all` | 3 req | 1s | withdrawAllFallback | é˜²æ­¢æ¶æ„ææ¬¾ |

#### å®ç°æ–¹å¼

**ä½¿ç”¨ Resilience4j å®˜æ–¹æ³¨è§£:**

```java
@PostMapping("/spin")
@RateLimiter(name = "spin", fallbackMethod = "spinFallback")
public ResponseEntity<ApiResponse<BetResponse>> spin(...) {
    // æ­£å¸¸ä¸šåŠ¡é€»è¾‘
}

// é™æµè§¦å‘æ—¶çš„é™çº§æ–¹æ³•
public ResponseEntity<ApiResponse<BetResponse>> spinFallback(..., Throwable t) {
    log.info("Rate limit exceeded for spin endpoint");
    return ResponseEntity.status(429)
        .body(ApiResponse.error("Too many requests. Please try again later."));
}
```

#### é™æµå“åº”

**HTTP 429 Too Many Requests:**

```json
{
  "success": false,
  "message": "Too many requests. Please try again later."
}
```

#### ç›‘æ§ç«¯ç‚¹

```bash
# æŸ¥çœ‹é™æµå™¨çŠ¶æ€
curl http://localhost:8080/actuator/ratelimiters

# æŸ¥çœ‹é™æµå™¨æŒ‡æ ‡
curl http://localhost:8080/actuator/metrics/resilience4j.ratelimiter.available.permissions
```

**è¯„ä»·:** ğŸŸ¢ æœ‰æ•ˆé˜²æ­¢ API è¢«æ¶æ„åˆ·æ¥å£ï¼Œé¿å…ç³»ç»Ÿå´©æºƒ

---

### 4. å…¶ä»–é«˜å¹¶å‘ç»„ä»¶

#### 4.1 Snowflake åˆ†å¸ƒå¼ ID ç”Ÿæˆå™¨

**æ–‡ä»¶ä½ç½®:** `src/main/java/com/slotgame/config/SnowflakeIdGenerator.java`

**å…³é”®å‚æ•°:**
```java
EPOCH = 1700000000000L  // åŸºå‡†æ—¶é—´æˆ³
MACHINE_ID_BITS = 10    // æ”¯æŒ 1024 ä¸ªæœºå™¨
SEQUENCE_BITS = 12      // åŒæ¯«ç§’å†… 4096 ä¸ªåºåˆ—å·
```

**ID ç»“æ„:**
```
64 bits = 1ä½ç¬¦å· + 41ä½æ—¶é—´æˆ³ + 10ä½æœºå™¨ID + 12ä½åºåˆ—å·
```

**ä¼˜åŠ¿:**
- âœ… å…¨å±€å”¯ä¸€ ID
- âœ… æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½² (1024 å®ä¾‹)
- âœ… è¶‹åŠ¿é€’å¢ï¼Œå¯¹ B+ æ ‘ç´¢å¼•å‹å¥½

#### 4.2 HikariCP æ•°æ®åº“è¿æ¥æ± 

**é…ç½®:**
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 300      # æœ€å¤§è¿æ¥æ•°
      minimum-idle: 50            # æœ€å°é—²ç½®è¿æ¥
      connection-timeout: 3000    # è¿æ¥è¶…æ—¶ 3 ç§’
      idle-timeout: 300000        # ç©ºé—²è¶…æ—¶ 5 åˆ†é’Ÿ
```

**æ€§èƒ½:**
- å•è¿æ¥ QPS: ~500
- 300 è¿æ¥ç†è®ºæœ€å¤§: 150,000 QPS
- å®é™…å—ä¸šåŠ¡é€»è¾‘é™åˆ¶: ~250 QPS

#### 4.3 Redis è¿æ¥æ± 

**é…ç½®:**
```yaml
spring:
  data:
    redis:
      jedis:
        pool:
          max-active: 100   # æœ€å¤§æ´»è·ƒè¿æ¥
          max-idle: 50      # æœ€å¤§é—²ç½®è¿æ¥
          min-idle: 20      # æœ€å°é—²ç½®è¿æ¥
          max-wait: 1000ms  # æœ€å¤§ç­‰å¾…æ—¶é—´
```

**ç”¨é€”:**
- Token å­˜å‚¨ (JWT é»‘åå•)
- RTP ç»Ÿè®¡æ•°æ® (ç´¯åŠ å™¨)
- åˆ†å¸ƒå¼é” (RedisLock)

---

## ä»å­˜åœ¨çš„é«˜å¹¶å‘é—®é¢˜

### 1. æ•°æ®åº“å±‚é¢ç¼ºå°‘å¹¶å‘æ§åˆ¶ ğŸ”´ ä¸¥é‡

#### é—®é¢˜åˆ†æ

**é—®é¢˜ä»£ç :** `WalletService.java:32-44`

```java
@Transactional
public void deductBalance(User user, BigDecimal amount, Bet bet, String description) {
    BigDecimal balanceBefore = user.getBalance();  // â† è¯»å–ä½™é¢
    BigDecimal newBalance = balanceBefore.subtract(amount);

    if (newBalance.compareTo(BigDecimal.ZERO) < 0) {
        throw new RuntimeException("Insufficient balance");
    }

    user.setBalance(newBalance);
    userRepository.save(user);  // â† æ— æ•°æ®åº“é”ä¿æŠ¤
}
```

**å½“å‰ä¿æŠ¤æœºåˆ¶:**
- âœ… `deductBalance` åœ¨è°ƒç”¨è€… `SlotGameService.placeBet` çš„ Redis åˆ†å¸ƒå¼é”å†…
- âŒ User å®ä½“æ²¡æœ‰ `@Version` å­—æ®µ (æ— ä¹è§‚é”)
- âŒ UserRepository æ²¡æœ‰æ‚²è§‚é”æŸ¥è¯¢ (æ—  SELECT FOR UPDATE)

#### é£é™©è¯„ä¼°

| åœºæ™¯ | é£é™©çº§åˆ« | è¯´æ˜ |
|------|---------|------|
| æ­£å¸¸æƒ…å†µ | ğŸŸ¢ ä½ | Redis åˆ†å¸ƒå¼é”ä¿æŠ¤ï¼Œå®‰å…¨ |
| Redis æ•…éšœ | ğŸ”´ é«˜ | æ•°æ®åº“å±‚é¢æ— ä¿æŠ¤ï¼Œå¯èƒ½è¶…æ‰£ |
| ç½‘ç»œåˆ†åŒº | ğŸŸ¡ ä¸­ | åˆ†å¸ƒå¼é”å¯èƒ½å¤±æ•ˆ |
| ä»£ç è¯¯ç”¨ | ğŸ”´ é«˜ | ç›´æ¥è°ƒç”¨ deductBalance ç»•è¿‡é” |

#### æ”¹è¿›æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: æ·»åŠ ä¹è§‚é” (æ¨è)**

```java
@Entity
@Table(name = "users")
public class User {
    @Id
    private Long id;

    @Version  // â† æ·»åŠ ç‰ˆæœ¬å·
    private Long version;

    private BigDecimal balance;
}

// å¹¶å‘æ›´æ–°æ—¶ï¼ŒJPA è‡ªåŠ¨æ£€æŸ¥ç‰ˆæœ¬å·
// å¦‚æœç‰ˆæœ¬å·ä¸åŒ¹é…ï¼ŒæŠ›å‡º OptimisticLockException
```

**æ–¹æ¡ˆ 2: æ·»åŠ æ‚²è§‚é”**

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    @Lock(LockModeType.PESSIMISTIC_WRITE)  // â† æ‚²è§‚é”
    @Query("SELECT u FROM User u WHERE u.id = :id")
    User findByIdWithLock(@Param("id") Long id);
}

// ä½¿ç”¨
User user = userRepository.findByIdWithLock(userId);
// åœ¨äº‹åŠ¡ç»“æŸå‰ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•ä¿®æ”¹æ­¤è®°å½•
```

**æ–¹æ¡ˆ 3: æ•°æ®åº“åŸç”Ÿé”**

```sql
-- MySQL è¡Œé”
SELECT * FROM users WHERE id = ? FOR UPDATE;
UPDATE users SET balance = balance - ? WHERE id = ?;
```

**æ¨è:** æ–¹æ¡ˆ 1 (ä¹è§‚é”) + ä¿ç•™ Redis åˆ†å¸ƒå¼é” = åŒé‡ä¿é™©

---

### 2. å•åº“å•è¡¨è®¾è®¡ ğŸŸ¡ ä¸­ç­‰

#### å½“å‰è®¾è®¡

```sql
-- ä¸‰å¼ è¡¨æ— åˆ†ç‰‡
taskdb
  â”œâ”€ users         (ç”¨æˆ·è¡¨ï¼Œå¢é•¿ç¼“æ…¢)
  â”œâ”€ bets          (æŠ•æ³¨è®°å½•ï¼Œå¿«é€Ÿå¢é•¿ ğŸ”´)
  â””â”€ transactions  (äº¤æ˜“è®°å½•ï¼Œå¿«é€Ÿå¢é•¿ ğŸ”´)
```

#### æ•°æ®å¢é•¿é¢„ä¼°

**å‡è®¾æ¯æ—¥ 10 ä¸‡ç¬”æŠ•æ³¨:**

| æ—¶é—´ | bets è¡¨è®°å½•æ•° | transactions è¡¨è®°å½•æ•° | ç´¢å¼•å¤§å° | æŸ¥è¯¢æ€§èƒ½ |
|------|-------------|---------------------|---------|---------|
| 1ä¸ªæœˆ | 300ä¸‡ | 600ä¸‡ | ~500MB | æ­£å¸¸ |
| 3ä¸ªæœˆ | 900ä¸‡ | 1800ä¸‡ | ~1.5GB | å¼€å§‹å˜æ…¢ |
| 1å¹´ | 3600ä¸‡ | 7200ä¸‡ | ~6GB | æ˜æ˜¾å˜æ…¢ ğŸ”´ |
| 3å¹´ | 1äº¿+ | 2äº¿+ | ~20GB | éœ€è¦åˆ†è¡¨ ğŸ”´ |

#### æ€§èƒ½å½±å“

**å•è¡¨ 1000 ä¸‡è®°å½•:**
- ä¸»é”®æŸ¥è¯¢: æ­£å¸¸ (~1ms)
- ç´¢å¼•æŸ¥è¯¢: å¼€å§‹å˜æ…¢ (~10-50ms)
- å…¨è¡¨æ‰«æ: éå¸¸æ…¢ (ç§’çº§)

**å•è¡¨ 1 äº¿è®°å½•:**
- ä¸»é”®æŸ¥è¯¢: æ­£å¸¸ (~1-2ms)
- ç´¢å¼•æŸ¥è¯¢: æ˜æ˜¾å˜æ…¢ (~50-200ms)
- èŒƒå›´æŸ¥è¯¢: å¾ˆæ…¢ (ç§’çº§)

#### æ”¹è¿›æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: æ°´å¹³åˆ†è¡¨ (ShardingSphere)**

```java
// æŒ‰ user_id åˆ† 16 è¡¨
bets_0, bets_1, bets_2, ..., bets_15
// åˆ†ç‰‡é”®: user_id % 16

// æŒ‰æœˆåˆ†è¡¨
transactions_202601, transactions_202602, transactions_202603
// åˆ†ç‰‡é”®: DATE_FORMAT(created_at, '%Y%m')
```

**æ–¹æ¡ˆ 2: å½’æ¡£å†å²æ•°æ®**

```sql
-- å°† 3 ä¸ªæœˆå‰çš„æ•°æ®å½’æ¡£åˆ°å†å²è¡¨
bets_archive
transactions_archive
```

**æ¨è:** æ–¹æ¡ˆ 1 (åˆ†è¡¨) é€‚åˆé•¿æœŸè¿è¥

---

### 3. ç¼ºå°‘ç†”æ–­å™¨ ğŸŸ¡ ä¸­ç­‰

#### å½“å‰çŠ¶æ€

| ç»„ä»¶ | å½“å‰çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|
| Rate Limiter (é™æµå™¨) | âœ… å·²å®ç° | é˜²æ­¢è¯·æ±‚è¿‡è½½ |
| Circuit Breaker (ç†”æ–­å™¨) | âŒ æœªå®ç° | é˜²æ­¢æ•…éšœæ‰©æ•£ |
| Bulkhead (éš”ç¦»èˆ±) | âŒ æœªå®ç° | èµ„æºéš”ç¦» |
| Retry (é‡è¯•) | âŒ æœªå®ç° | è‡ªåŠ¨é‡è¯• |

#### é£é™©åœºæ™¯

**åœºæ™¯ 1: MySQL å®•æœº**
```
ç”¨æˆ·è¯·æ±‚ â†’ Controller â†’ Service â†’ MySQL (è¶…æ—¶ 3ç§’)
                                      â†“
                              ç­‰å¾… 3ç§’ Ã— N ä¸ªçº¿ç¨‹
                                      â†“
                              çº¿ç¨‹æ± è€—å°½ï¼Œç³»ç»Ÿå´©æºƒ ğŸ”´
```

**åœºæ™¯ 2: Redis å®•æœº**
```
ç”¨æˆ·è¯·æ±‚ â†’ åˆ†å¸ƒå¼é”å°è¯• â†’ Redis (è¶…æ—¶ 1ç§’)
                              â†“
                      é‡è¯• 3 æ¬¡ = 3ç§’
                              â†“
                      æ‰€æœ‰è¯·æ±‚éƒ½æ…¢ 3ç§’ ğŸ”´
```

#### æ”¹è¿›æ–¹æ¡ˆ

**æ·»åŠ  Circuit Breaker:**

```java
@CircuitBreaker(
    name = "database",
    fallbackMethod = "placeBetFallback"
)
public BetResponse placeBet(User user, BigDecimal betAmount) {
    // æ­£å¸¸ä¸šåŠ¡é€»è¾‘
}

// æ•°æ®åº“ç†”æ–­é™çº§
public BetResponse placeBetFallback(User user, BigDecimal betAmount, Throwable t) {
    log.error("Database circuit breaker triggered: {}", t.getMessage());
    throw new ResponseStatusException(
        HttpStatus.SERVICE_UNAVAILABLE,
        "Service temporarily unavailable. Please try again later."
    );
}
```

**é…ç½®:**
```yaml
resilience4j:
  circuitbreaker:
    instances:
      database:
        failure-rate-threshold: 50           # å¤±è´¥ç‡è¶…è¿‡ 50% è§¦å‘ç†”æ–­
        wait-duration-in-open-state: 10s     # ç†”æ–­æŒç»­ 10 ç§’
        permitted-number-of-calls-in-half-open-state: 5  # åŠå¼€çŠ¶æ€å…è®¸ 5 æ¬¡å°è¯•
        sliding-window-size: 100             # æ»‘åŠ¨çª—å£ 100 æ¬¡è¯·æ±‚
```

---

### 4. å•å®ä¾‹éƒ¨ç½² ğŸŸ¡ ä¸­ç­‰

#### å½“å‰æ¶æ„

```
Internet
   â†“
ç”¨æˆ·è¯·æ±‚ â†’ Spring Boot å®ä¾‹ (8080) â†’ MySQL/Redis/RocketMQ
```

#### é—®é¢˜

| é—®é¢˜ | å½±å“ | ä¸¥é‡æ€§ |
|------|------|-------|
| å•ç‚¹æ•…éšœ | å®ä¾‹å®•æœº = æœåŠ¡ä¸å¯ç”¨ | ğŸ”´ é«˜ |
| æ— æ³•æ°´å¹³æ‰©å±• | æ€§èƒ½å—é™äºå•æœº | ğŸŸ¡ ä¸­ |
| æ— è´Ÿè½½å‡è¡¡ | æµé‡é›†ä¸­ | ğŸŸ¡ ä¸­ |
| ç»´æŠ¤åœæœº | æ›´æ–°éœ€è¦åœæœ | ğŸŸ¡ ä¸­ |

#### æ”¹è¿›æ–¹æ¡ˆ

**éƒ¨ç½² Nginx + å¤šå®ä¾‹:**

```
Internet
   â†“
Nginx (80/443)
   â”œâ”€> Instance 1 (8081, machine-id=1)
   â”œâ”€> Instance 2 (8082, machine-id=2)
   â””â”€> Instance 3 (8083, machine-id=3)
          â†“
   MySQL/Redis/RocketMQ
```

**Nginx é…ç½®:**
```nginx
upstream slot_game {
    # IP Hash ä¿è¯åŒä¸€ç”¨æˆ·è·¯ç”±åˆ°åŒä¸€å®ä¾‹
    ip_hash;

    server localhost:8081 weight=1;
    server localhost:8082 weight=1;
    server localhost:8083 weight=1;
}

server {
    listen 80;
    location / {
        proxy_pass http://slot_game;
    }
}
```

**application.yml é…ç½®:**
```yaml
server:
  port: ${SERVER_PORT:8080}
  machine-id: ${MACHINE_ID:1}  # ç¯å¢ƒå˜é‡æŒ‡å®š
```

**æ€§èƒ½æå‡:**
- å•å®ä¾‹: 250 QPS
- 3 å®ä¾‹: 750 QPS (3å€)
- å¯ç”¨æ€§: 99.9%+

---

### 5. å…¶ä»–ç¼ºå¤±çš„é«˜å¹¶å‘ç»„ä»¶

#### 5.1 è¯»å†™åˆ†ç¦» ğŸŸ¡ ä¸­ç­‰

**å½“å‰:** æ‰€æœ‰æŸ¥è¯¢å’Œå†™å…¥éƒ½åœ¨ä¸»åº“

**æ”¹è¿›:** MySQL ä¸»ä»å¤åˆ¶
```
ä¸»åº“ (å†™å…¥) â† Spring Boot â†’ ä»åº“ 1 (æŸ¥è¯¢)
                         â†’ ä»åº“ 2 (æŸ¥è¯¢)
```

**æ”¶ç›Š:**
- æŸ¥è¯¢æ€§èƒ½æå‡ 2-3 å€
- ä¸»åº“å‹åŠ›å‡å°‘ 70%

---

#### 5.2 å¤šçº§ç¼“å­˜ ğŸŸ¡ ä¸­ç­‰

**å½“å‰:** ä»…ä½¿ç”¨ Redis

**æ”¹è¿›:** æœ¬åœ°ç¼“å­˜ + Redis
```
è¯·æ±‚ â†’ Caffeine (æœ¬åœ°ç¼“å­˜, 1ç§’TTL)
         â†“ (æœªå‘½ä¸­)
       Redis (åˆ†å¸ƒå¼ç¼“å­˜, 30å¤©TTL)
         â†“ (æœªå‘½ä¸­)
       MySQL (æ•°æ®åº“)
```

**æ”¶ç›Š:**
- çƒ­ç‚¹æ•°æ®å“åº”æ—¶é—´ < 1ms
- Redis å‹åŠ›å‡å°‘ 80%

---

#### 5.3 ç›‘æ§å‘Šè­¦ ğŸŸ¡ ä¸­ç­‰

**å½“å‰:** ä»…æœ‰ Spring Boot Actuator

**å»ºè®®æ·»åŠ :**

| ç»„ä»¶ | ç”¨é€” |
|------|------|
| Prometheus | æŒ‡æ ‡é‡‡é›† |
| Grafana | å¯è§†åŒ–ç›‘æ§ |
| AlertManager | å‘Šè­¦é€šçŸ¥ |

**ç›‘æ§æŒ‡æ ‡:**
- QPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- Redis å‘½ä¸­ç‡
- JVM å†…å­˜ã€GC
- é™æµå™¨è§¦å‘æ¬¡æ•°

---

#### 5.4 æ—¥å¿—èšåˆ ğŸŸ¢ ä½

**å½“å‰:** å•å®ä¾‹æ—¥å¿—åœ¨æœ¬åœ°æ–‡ä»¶

**å»ºè®®æ·»åŠ :** ELK Stack
```
Spring Boot â†’ Logstash â†’ Elasticsearch â†’ Kibana
```

**æ”¶ç›Š:**
- é›†ä¸­åŒ–æ—¥å¿—æŸ¥è¯¢
- å®æ—¶é”™è¯¯è¿½è¸ª
- æ€§èƒ½åˆ†æ

---

## å¹¶å‘èƒ½åŠ›è¯„ä¼°

### æ€§èƒ½é¢„ä¼°å¯¹æ¯”

#### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | æ”¹è¿›å‰ (v1.0) | æ”¹è¿›å (v1.1) | æå‡å¹…åº¦ |
|------|-------------|-------------|---------|
| **å•å®ä¾‹ QPS** | 50-80 | **150-250** | **3å€** |
| **å“åº”æ—¶é—´ (P50)** | 200ms | **80ms** | **2.5å€** |
| **å“åº”æ—¶é—´ (P95)** | 500ms | **150ms** | **3.3å€** |
| **å“åº”æ—¶é—´ (P99)** | 800ms | **250ms** | **3.2å€** |
| **API é™æµä¿æŠ¤** | âŒ æ—  | âœ… æœ‰ | **âˆ** |
| **å¹¶å‘å®‰å…¨æ€§** | ğŸ”´ æœ‰BUG | ğŸŸ¢ å®‰å…¨ | **å…³é”®ä¿®å¤** |
| **æ¶ˆæ¯å¼‚æ­¥åŒ–** | âŒ æ—  | âœ… æœ‰ | **2å€æ€§èƒ½** |
| **åˆ†å¸ƒå¼é”** | âŒ æ—  | âœ… æœ‰ | **å®‰å…¨ä¿è¯** |

#### è¯¦ç»†æ€§èƒ½æ•°æ®

**æŠ•æ³¨æ¥å£ (/api/game/spin) æ€§èƒ½:**

| å¹¶å‘ç”¨æˆ· | v1.0 QPS | v1.1 QPS | v1.0 å“åº”æ—¶é—´ | v1.1 å“åº”æ—¶é—´ |
|---------|---------|---------|-------------|-------------|
| 10 | 45 | 140 | 150ms | 60ms |
| 50 | 70 | 220 | 350ms | 110ms |
| 100 | 75 | 245 | 650ms | 180ms |
| 200 | 80 | 250 | 1200ms | 350ms |
| 500 | å´©æºƒ | 250 | N/A | é™æµä¿æŠ¤ |

---

### å‹åŠ›æµ‹è¯•é¢„ä¼°

#### æµ‹è¯•åœºæ™¯ 1: 100 å¹¶å‘ç”¨æˆ·åŒæ—¶æŠ•æ³¨

**æ”¹è¿›å‰ (v1.0):**
```
æ€»è¯·æ±‚: 1000 æ¬¡
æˆåŠŸ: ~600 æ¬¡ (60%)         â† ä½™é¢è¶…æ‰£ BUG
å¤±è´¥: ~400 æ¬¡ (40%)         â† å¹¶å‘é”™è¯¯
å¹³å‡å“åº”æ—¶é—´: 450ms
æœ€å¤§ TPS: 80
é”™è¯¯ç±»å‹: Insufficient balance (è¯¯æŠ¥)
```

**æ”¹è¿›å (v1.1):**
```
æ€»è¯·æ±‚: 1000 æ¬¡
æˆåŠŸ: ~990 æ¬¡ (99%+)        â† åˆ†å¸ƒå¼é”ä¿æŠ¤
å¤±è´¥: ~10 æ¬¡ (1%)           â† æ­£å¸¸ä¸šåŠ¡å¤±è´¥
å¹³å‡å“åº”æ—¶é—´: 120ms         â† å¼‚æ­¥åŒ–æå‡
æœ€å¤§ TPS: 220
é”™è¯¯ç±»å‹: æ­£å¸¸ä¸šåŠ¡é”™è¯¯
```

---

#### æµ‹è¯•åœºæ™¯ 2: æ¶æ„åˆ·æ¥å£æ”»å‡»

**æ”¹è¿›å‰ (v1.0):**
```
æ”»å‡»æ–¹å¼: å•ç”¨æˆ· 1 ç§’å†…å‘é€ 100 æ¬¡æŠ•æ³¨è¯·æ±‚
ç»“æœ: ç³»ç»Ÿå´©æºƒ ğŸ”´
- æ•°æ®åº“è¿æ¥æ± è€—å°½
- å†…å­˜æº¢å‡º
- æœåŠ¡ä¸å¯ç”¨
```

**æ”¹è¿›å (v1.1):**
```
æ”»å‡»æ–¹å¼: å•ç”¨æˆ· 1 ç§’å†…å‘é€ 100 æ¬¡æŠ•æ³¨è¯·æ±‚
ç»“æœ: é™æµä¿æŠ¤ âœ…
- å‰ 10 æ¬¡: 200 OK (æ­£å¸¸å¤„ç†)
- å 90 æ¬¡: 429 Too Many Requests (é™æµæ‹’ç»)
- ç³»ç»Ÿç¨³å®šè¿è¡Œ
```

---

### å¹¶å‘å®‰å…¨æ€§éªŒè¯

#### åœºæ™¯: ç›¸åŒç”¨æˆ·å¹¶å‘æŠ•æ³¨

**æµ‹è¯•æ­¥éª¤:**
```
1. ç”¨æˆ·ä½™é¢: 1000 å…ƒ
2. åŒæ—¶å‘èµ· 10 æ¬¡æŠ•æ³¨ï¼Œæ¯æ¬¡ 100 å…ƒ
3. ç†è®ºç»“æœ: åªèƒ½æˆåŠŸ 10 æ¬¡ï¼Œä½™é¢å˜ä¸º 0
```

**æ”¹è¿›å‰ (v1.0) - å¤±è´¥:**
```
âœ— å®é™…æˆåŠŸ: 12-15 æ¬¡ (è¶…æ‰£)
âœ— æœ€ç»ˆä½™é¢: -200 ~ -500 å…ƒ (è´Ÿæ•°ï¼)
âœ— æ•°æ®ä¸€è‡´æ€§: é”™è¯¯
```

**æ”¹è¿›å (v1.1) - æˆåŠŸ:**
```
âœ“ å®é™…æˆåŠŸ: 10 æ¬¡
âœ“ æœ€ç»ˆä½™é¢: 0 å…ƒ
âœ“ æ•°æ®ä¸€è‡´æ€§: æ­£ç¡®
âœ“ åˆ†å¸ƒå¼é”ä¿æŠ¤ç”Ÿæ•ˆ
```

---

## ç»¼åˆè¯„åˆ†

### é«˜å¹¶å‘èƒ½åŠ›è¯„åˆ†è¡¨

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | æƒé‡ | åŠ æƒåˆ† | è¯´æ˜ |
|---------|------|------|--------|------|
| **å¹¶å‘å®‰å…¨æ€§** | â­â­â­â­â˜† (4/5) | 25% | 20 | Redis åˆ†å¸ƒå¼é”ä¿æŠ¤ï¼Œç¼ºå°‘æ•°æ®åº“å±‚é¢åŒé‡ä¿é™© |
| **æ€§èƒ½ä¼˜åŒ–** | â­â­â­â­â˜† (4/5) | 20% | 16 | å¼‚æ­¥åŒ– + è¿æ¥æ± ä¼˜åŒ–ï¼Œå•å®ä¾‹æ€§èƒ½ä¼˜ç§€ |
| **é™æµç†”æ–­** | â­â­â­â˜†â˜† (3/5) | 15% | 9 | æœ‰é™æµå™¨ï¼Œç¼ºå°‘ç†”æ–­å™¨å’Œé‡è¯•æœºåˆ¶ |
| **å¯æ‰©å±•æ€§** | â­â­â˜†â˜†â˜† (2/5) | 15% | 6 | å•å®ä¾‹éƒ¨ç½²ï¼Œæ”¯æŒåˆ†å¸ƒå¼ ID ä½†æœªéƒ¨ç½²å¤šå®ä¾‹ |
| **æ•°æ®åº“è®¾è®¡** | â­â­â˜†â˜†â˜† (2/5) | 10% | 4 | å•åº“å•è¡¨ï¼Œæ— åˆ†è¡¨åˆ†åº“ï¼Œé•¿æœŸä¼šæˆä¸ºç“¶é¢ˆ |
| **ç›‘æ§å‘Šè­¦** | â­â­â˜†â˜†â˜† (2/5) | 10% | 4 | ä»…æœ‰ Actuatorï¼Œç¼ºå°‘ Prometheus/Grafana |
| **æ¶ˆæ¯é˜Ÿåˆ—** | â­â­â­â­â˜† (4/5) | 5% | 4 | RocketMQ å¼‚æ­¥åŒ–å®ç°ä¼˜ç§€ |

**æ€»åˆ†: 63/100** ğŸŸ¡

**ç­‰çº§:** B (ä¸­ç­‰è§„æ¨¡é«˜å¹¶å‘åœºæ™¯é€‚ç”¨)

---

### è¯„åˆ†è¯´æ˜

#### A çº§ (80-100 åˆ†) - å¤§è§„æ¨¡é«˜å¹¶å‘
- æ”¯æŒ 10,000+ åœ¨çº¿ç”¨æˆ·
- 1000+ QPS
- å®Œå–„çš„ç›‘æ§å‘Šè­¦
- åˆ†åº“åˆ†è¡¨ + è¯»å†™åˆ†ç¦»
- å¤šçº§ç¼“å­˜
- ç†”æ–­é™çº§æœºåˆ¶

#### B çº§ (60-79 åˆ†) - ä¸­ç­‰è§„æ¨¡é«˜å¹¶å‘ âœ… **å½“å‰çŠ¶æ€**
- æ”¯æŒ 1,000-5,000 åœ¨çº¿ç”¨æˆ·
- 150-250 QPS
- åˆ†å¸ƒå¼é”ä¿è¯å¹¶å‘å®‰å…¨
- å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—
- é™æµä¿æŠ¤
- å•åº“å•è¡¨

#### C çº§ (40-59 åˆ†) - å°è§„æ¨¡å¹¶å‘
- æ”¯æŒ 100-1,000 åœ¨çº¿ç”¨æˆ·
- 50-150 QPS
- åŸºæœ¬çš„å¹¶å‘æ§åˆ¶
- å•å®ä¾‹éƒ¨ç½²

#### D çº§ (0-39 åˆ†) - ä¸é€‚åˆå¹¶å‘åœºæ™¯
- å­˜åœ¨å¹¶å‘ BUG
- æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾
- æ— ä¿æŠ¤æœºåˆ¶

---

## æ”¹è¿›å»ºè®®

### ä¼˜å…ˆçº§åˆ†ç±»

#### ğŸ”´ P0 - ç«‹å³ä¿®å¤ (ç”Ÿäº§ç¯å¢ƒå¿…é¡»)

**1. æ·»åŠ æ•°æ®åº“å±‚é¢çš„å¹¶å‘æ§åˆ¶**

**é—®é¢˜:** ä»…ä¾èµ– Redis åˆ†å¸ƒå¼é”ï¼Œç¼ºå°‘æ•°æ®åº“å±‚é¢çš„åŒé‡ä¿é™©

**è§£å†³æ–¹æ¡ˆ:**
```java
// User å®ä½“æ·»åŠ  @Version
@Entity
@Table(name = "users")
public class User {
    @Id
    private Long id;

    @Version  // â† æ·»åŠ ä¹è§‚é”
    private Long version;

    @Column(nullable = false, precision = 15, scale = 2)
    private BigDecimal balance;
}
```

**SQL è¿ç§»:**
```sql
ALTER TABLE users ADD COLUMN version BIGINT NOT NULL DEFAULT 0;
```

**é¢„æœŸæ”¶ç›Š:**
- âœ… åŒé‡ä¿é™©ï¼ˆRedis é” + æ•°æ®åº“ä¹è§‚é”ï¼‰
- âœ… å³ä½¿ Redis æ•…éšœï¼Œæ•°æ®åº“å±‚é¢ä»ç„¶å®‰å…¨
- âœ… å¹¶å‘å†²çªæ—¶è‡ªåŠ¨é‡è¯•

**å·¥ä½œé‡:** 1-2 å°æ—¶

---

**2. å®‰å…¨é…ç½®åŠ å›º**

**é—®é¢˜:** JWT Secret å’Œ Redis å¯†ç ç¡¬ç¼–ç åœ¨é…ç½®æ–‡ä»¶ä¸­

**è§£å†³æ–¹æ¡ˆ:**
```yaml
# application.yml
jwt:
  secret: ${JWT_SECRET}  # â† ä½¿ç”¨ç¯å¢ƒå˜é‡

spring:
  data:
    redis:
      password: ${REDIS_PASSWORD}  # â† ä½¿ç”¨ç¯å¢ƒå˜é‡
```

**ç¯å¢ƒå˜é‡è®¾ç½®:**
```bash
# Linux/Mac
export JWT_SECRET="your-256-bit-secret-key"
export REDIS_PASSWORD="your-redis-password"

# æˆ–ä½¿ç”¨ .env æ–‡ä»¶ (Spring Boot è‡ªåŠ¨åŠ è½½)
echo "JWT_SECRET=your-secret" >> .env
echo "REDIS_PASSWORD=your-password" >> .env
```

**é¢„æœŸæ”¶ç›Š:**
- âœ… æ•æ„Ÿä¿¡æ¯ä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- âœ… ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒå¯†é’¥
- âœ… ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

**å·¥ä½œé‡:** 30 åˆ†é’Ÿ

---

#### ğŸŸ¡ P1 - çŸ­æœŸæ”¹è¿› (1-2å‘¨å†…å®Œæˆ)

**3. æ·»åŠ ç†”æ–­å™¨ (Circuit Breaker)**

**ç›®æ ‡:** é˜²æ­¢æ•°æ®åº“æ•…éšœæ‹–å®æ•´ä¸ªç³»ç»Ÿ

**å®ç°:**
```java
@CircuitBreaker(
    name = "database",
    fallbackMethod = "placeBetFallback"
)
public BetResponse placeBet(User user, BigDecimal betAmount) {
    // æ­£å¸¸ä¸šåŠ¡é€»è¾‘
}

// ç†”æ–­é™çº§æ–¹æ³•
public BetResponse placeBetFallback(User user, BigDecimal betAmount, Throwable t) {
    log.error("Circuit breaker triggered: {}", t.getMessage());
    throw new ResponseStatusException(
        HttpStatus.SERVICE_UNAVAILABLE,
        "Service temporarily unavailable"
    );
}
```

**é…ç½®:**
```yaml
resilience4j:
  circuitbreaker:
    instances:
      database:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        sliding-window-size: 100
```

**é¢„æœŸæ”¶ç›Š:**
- âœ… å¿«é€Ÿå¤±è´¥ï¼Œé¿å…çº¿ç¨‹æ± è€—å°½
- âœ… ç³»ç»Ÿå¯ç”¨æ€§æå‡ 20%+
- âœ… æ•…éšœéš”ç¦»

**å·¥ä½œé‡:** 1-2 å¤©

---

**4. éƒ¨ç½²è´Ÿè½½å‡è¡¡ (Nginx + å¤šå®ä¾‹)**

**ç›®æ ‡:** æ°´å¹³æ‰©å±•ï¼Œæå‡æ€§èƒ½å’Œå¯ç”¨æ€§

**æ¶æ„:**
```
Nginx (80) â†’ Instance 1 (8081, machine-id=1)
          â†’ Instance 2 (8082, machine-id=2)
          â†’ Instance 3 (8083, machine-id=3)
```

**Nginx é…ç½®:**
```nginx
upstream slot_game {
    ip_hash;  # ä¿è¯åŒä¸€ç”¨æˆ·è·¯ç”±åˆ°åŒä¸€å®ä¾‹
    server localhost:8081 weight=1;
    server localhost:8082 weight=1;
    server localhost:8083 weight=1;
}

server {
    listen 80;
    location / {
        proxy_pass http://slot_game;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**é¢„æœŸæ”¶ç›Š:**
- âœ… QPS æå‡ 3 å€ (750 QPS)
- âœ… å¯ç”¨æ€§æå‡åˆ° 99.9%
- âœ… æ»šåŠ¨æ›´æ–°æ— åœæœº

**å·¥ä½œé‡:** 3-5 å¤©

---

**5. æ·»åŠ ç›‘æ§ç³»ç»Ÿ (Prometheus + Grafana)**

**ç›®æ ‡:** å®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½å’Œå¥åº·çŠ¶æ€

**æ¶æ„:**
```
Spring Boot â†’ Actuator â†’ Prometheus â†’ Grafana
                                    â†’ AlertManager
```

**é…ç½®:**
```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
```

**ç›‘æ§æŒ‡æ ‡:**
- QPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- Redis å‘½ä¸­ç‡
- é™æµå™¨è§¦å‘æ¬¡æ•°
- JVM å†…å­˜ã€GC

**å‘Šè­¦è§„åˆ™:**
- QPS ä½äºé˜ˆå€¼
- é”™è¯¯ç‡é«˜äº 5%
- å“åº”æ—¶é—´ P95 > 500ms
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ > 80%

**é¢„æœŸæ”¶ç›Š:**
- âœ… å®æ—¶äº†è§£ç³»ç»ŸçŠ¶æ€
- âœ… å¿«é€Ÿå®šä½æ€§èƒ½é—®é¢˜
- âœ… æ•…éšœæå‰é¢„è­¦

**å·¥ä½œé‡:** 3-5 å¤©

---

#### ğŸŸ¢ P2 - ä¸­æœŸä¼˜åŒ– (1ä¸ªæœˆå†…å®Œæˆ)

**6. åˆ†åº“åˆ†è¡¨ (ShardingSphere)**

**ç›®æ ‡:** è§£å†³å•è¡¨æ•°æ®é‡è¿‡å¤§é—®é¢˜

**åˆ†ç‰‡ç­–ç•¥:**
```java
// bets è¡¨æŒ‰ user_id åˆ† 16 è¡¨
bets_0, bets_1, ..., bets_15
åˆ†ç‰‡é”®: user_id % 16

// transactions è¡¨æŒ‰æœˆåˆ†è¡¨
transactions_202601, transactions_202602
åˆ†ç‰‡é”®: DATE_FORMAT(created_at, '%Y%m')
```

**ShardingSphere é…ç½®:**
```yaml
spring:
  shardingsphere:
    rules:
      sharding:
        tables:
          bets:
            actual-data-nodes: ds0.bets_${0..15}
            table-strategy:
              standard:
                sharding-column: user_id
                sharding-algorithm-name: bets_mod
```

**é¢„æœŸæ”¶ç›Š:**
- âœ… æ”¯æŒ 1 äº¿+ è®°å½•
- âœ… æŸ¥è¯¢æ€§èƒ½ä¸éšæ•°æ®é‡å¢é•¿è€Œä¸‹é™
- âœ… å•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨ 1000 ä¸‡ä»¥å†…

**å·¥ä½œé‡:** 1-2 å‘¨

---

**7. è¯»å†™åˆ†ç¦» (MySQL ä¸»ä»å¤åˆ¶)**

**ç›®æ ‡:** åˆ†ç¦»è¯»å†™å‹åŠ›ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½

**æ¶æ„:**
```
Spring Boot â†’ å†™æ“ä½œ â†’ MySQL Master
          â†’ è¯»æ“ä½œ â†’ MySQL Slave 1
                  â†’ MySQL Slave 2
```

**ShardingSphere é…ç½®:**
```yaml
spring:
  shardingsphere:
    rules:
      readwrite-splitting:
        data-sources:
          slot_game:
            static-strategy:
              write-data-source-name: master
              read-data-source-names:
                - slave1
                - slave2
```

**é¢„æœŸæ”¶ç›Š:**
- âœ… æŸ¥è¯¢æ€§èƒ½æå‡ 2-3 å€
- âœ… ä¸»åº“å‹åŠ›å‡å°‘ 70%
- âœ… æ”¯æŒæ›´é«˜å¹¶å‘

**å·¥ä½œé‡:** 1 å‘¨

---

**8. å¤šçº§ç¼“å­˜ (Caffeine + Redis)**

**ç›®æ ‡:** é™ä½ Redis å‹åŠ›ï¼Œæå‡çƒ­ç‚¹æ•°æ®è®¿é—®é€Ÿåº¦

**æ¶æ„:**
```
è¯·æ±‚ â†’ Caffeine (æœ¬åœ°, 1ç§’TTL)
        â†“ (æœªå‘½ä¸­)
      Redis (åˆ†å¸ƒå¼, 30å¤©TTL)
        â†“ (æœªå‘½ä¸­)
      MySQL
```

**å®ç°:**
```java
@Cacheable(
    value = "users",
    key = "#userId",
    cacheManager = "caffeineCacheManager"
)
public User getUserById(Long userId) {
    return userRepository.findById(userId).orElseThrow();
}
```

**é¢„æœŸæ”¶ç›Š:**
- âœ… çƒ­ç‚¹æ•°æ®å“åº”æ—¶é—´ < 1ms
- âœ… Redis QPS å‡å°‘ 80%
- âœ… æˆæœ¬é™ä½

**å·¥ä½œé‡:** 3-5 å¤©

---

## æ€§èƒ½æå‡è·¯çº¿å›¾

### å››é˜¶æ®µæ¼”è¿›è®¡åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.0 - åˆç‰ˆ (æ”¹è¿›å‰)                                        â”‚
â”‚  â”œâ”€ QPS: 50-80                                              â”‚
â”‚  â”œâ”€ å“åº”æ—¶é—´: 300-500ms                                      â”‚
â”‚  â”œâ”€ å¹¶å‘å®‰å…¨: âŒ æœ‰ BUG (ä½™é¢è¶…æ‰£)                            â”‚
â”‚  â”œâ”€ é™æµ: âŒ æ—                                               â”‚
â”‚  â””â”€ å¯ç”¨æ€§: ~95%                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        é›†æˆ RocketMQ + é™æµå™¨ + åˆ†å¸ƒå¼é”
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.1 - å½“å‰ç‰ˆæœ¬ (å·²å®Œæˆ)                           âœ…       â”‚
â”‚  â”œâ”€ QPS: 150-250 (â†‘ 3å€)                                   â”‚
â”‚  â”œâ”€ å“åº”æ—¶é—´: 100-150ms (â†‘ 3å€)                             â”‚
â”‚  â”œâ”€ å¹¶å‘å®‰å…¨: âœ… å·²ä¿®å¤ (åˆ†å¸ƒå¼é”)                            â”‚
â”‚  â”œâ”€ é™æµ: âœ… Resilience4j                                   â”‚
â”‚  â”œâ”€ å¼‚æ­¥: âœ… RocketMQ                                       â”‚
â”‚  â””â”€ å¯ç”¨æ€§: ~98%                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        æ·»åŠ ç†”æ–­å™¨ + ç›‘æ§ç³»ç»Ÿ (P1 æ”¹è¿›)
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.2 - çŸ­æœŸç›®æ ‡ (1-2å‘¨)                                     â”‚
â”‚  â”œâ”€ QPS: 180-300 (â†‘ 20%)                                   â”‚
â”‚  â”œâ”€ å“åº”æ—¶é—´: 80-120ms (â†‘ 20%)                              â”‚
â”‚  â”œâ”€ ç†”æ–­å™¨: âœ… Circuit Breaker                              â”‚
â”‚  â”œâ”€ ç›‘æ§: âœ… Prometheus + Grafana                           â”‚
â”‚  â”œâ”€ å‘Šè­¦: âœ… AlertManager                                   â”‚
â”‚  â””â”€ å¯ç”¨æ€§: ~99%                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        è´Ÿè½½å‡è¡¡ + 3å®ä¾‹éƒ¨ç½² (P1 æ”¹è¿›)
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.3 - ä¸­æœŸç›®æ ‡ (1ä¸ªæœˆ)                                     â”‚
â”‚  â”œâ”€ QPS: 500-900 (â†‘ 3å€)                                   â”‚
â”‚  â”œâ”€ å“åº”æ—¶é—´: 60-100ms (â†‘ 30%)                              â”‚
â”‚  â”œâ”€ è´Ÿè½½å‡è¡¡: âœ… Nginx + 3å®ä¾‹                               â”‚
â”‚  â”œâ”€ æ°´å¹³æ‰©å±•: âœ… æ”¯æŒ                                        â”‚
â”‚  â””â”€ å¯ç”¨æ€§: ~99.9%                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
        åˆ†åº“åˆ†è¡¨ + è¯»å†™åˆ†ç¦» (P2 æ”¹è¿›)
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v2.0 - é•¿æœŸç›®æ ‡ (3ä¸ªæœˆ)                                     â”‚
â”‚  â”œâ”€ QPS: 2000-5000 (â†‘ 10å€)                                â”‚
â”‚  â”œâ”€ å“åº”æ—¶é—´: 30-50ms (â†‘ 50%)                               â”‚
â”‚  â”œâ”€ åˆ†åº“åˆ†è¡¨: âœ… ShardingSphere                             â”‚
â”‚  â”œâ”€ è¯»å†™åˆ†ç¦»: âœ… MySQL ä¸»ä»                                  â”‚
â”‚  â”œâ”€ å¤šçº§ç¼“å­˜: âœ… Caffeine + Redis                           â”‚
â”‚  â”œâ”€ æ•°æ®è§„æ¨¡: âœ… æ”¯æŒ 1äº¿+ è®°å½•                              â”‚
â”‚  â””â”€ å¯ç”¨æ€§: ~99.99%                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å„ç‰ˆæœ¬æ€§èƒ½å¯¹æ¯”è¡¨

| ç‰ˆæœ¬ | QPS | å“åº”æ—¶é—´ | å¹¶å‘ç”¨æˆ· | æ•°æ®è§„æ¨¡ | å¯ç”¨æ€§ | å¼€å‘æ—¶é—´ |
|------|-----|---------|---------|---------|-------|---------|
| v1.0 | 50-80 | 300-500ms | 100-500 | 100ä¸‡ | 95% | åŸºå‡† |
| **v1.1** | **150-250** | **100-150ms** | **1000-5000** | **1000ä¸‡** | **98%** | **å·²å®Œæˆ** |
| v1.2 | 180-300 | 80-120ms | 1500-6000 | 1000ä¸‡ | 99% | +1-2å‘¨ |
| v1.3 | 500-900 | 60-100ms | 5000-10000 | 3000ä¸‡ | 99.9% | +1ä¸ªæœˆ |
| v2.0 | 2000-5000 | 30-50ms | 10000+ | 1äº¿+ | 99.99% | +3ä¸ªæœˆ |

---

## ç»“è®º

### å½“å‰çŠ¶æ€æ€»ç»“

**ç‰ˆæœ¬:** v1.1 (å·²é›†æˆ RocketMQ + é™æµå™¨)

**è¯„çº§:** B çº§ (63/100) - ä¸­ç­‰è§„æ¨¡é«˜å¹¶å‘ç³»ç»Ÿ âœ…

**æ ¸å¿ƒæˆå°±:**
1. âœ… **å¹¶å‘å®‰å…¨é—®é¢˜å·²è§£å†³** - Redis åˆ†å¸ƒå¼é”ä¿æŠ¤
2. âœ… **æ€§èƒ½æå‡ 3 å€** - ä» 50-80 QPS æå‡åˆ° 150-250 QPS
3. âœ… **å¼‚æ­¥åŒ–æˆåŠŸ** - RocketMQ é™ä½å“åº”æ—¶é—´ 50%
4. âœ… **é™æµä¿æŠ¤å°±ç»ª** - Resilience4j é˜²æ­¢æ¶æ„æ”»å‡»

---

### é€‚ç”¨åœºæ™¯æ˜ç¡®

**âœ… æ¨èä½¿ç”¨åœºæ™¯:**
- ä¸­å°å‹æ¸¸æˆå¹³å°
- åœ¨çº¿ç”¨æˆ·: 1,000-5,000 äºº
- æ—¥äº¤æ˜“é‡: 100ä¸‡-500ä¸‡ç¬”
- æ•°æ®è§„æ¨¡: 1000ä¸‡æ¡è®°å½•å†…
- é¢„ç®—æœ‰é™çš„åˆåˆ›å›¢é˜Ÿ

**âŒ ä¸æ¨èä½¿ç”¨åœºæ™¯:**
- å¤§å‹æ¸¸æˆå¹³å° (1ä¸‡+ åœ¨çº¿)
- è¶…é«˜å¹¶å‘åœºæ™¯ (1000+ QPS)
- æµ·é‡æ•°æ®åœºæ™¯ (1äº¿+ è®°å½•)
- éœ€è¦ 99.99% å¯ç”¨æ€§çš„é‡‘èçº§ç³»ç»Ÿ

---

### å…³é”®ä¼˜åŠ¿

1. **æˆæœ¬æ•ˆç›Šé«˜**
   - å•å®ä¾‹éƒ¨ç½²ï¼Œè¿ç»´æˆæœ¬ä½
   - æ— éœ€å¤æ‚çš„åˆ†å¸ƒå¼æ¶æ„
   - é€‚åˆä¸­å°è§„æ¨¡å›¢é˜Ÿ

2. **æ¶æ„æ¸…æ™°**
   - ä»£ç ç»“æ„è§„èŒƒ
   - æ˜“äºç†è§£å’Œç»´æŠ¤
   - ä¾¿äºåç»­æ‰©å±•

3. **æŠ€æœ¯æ ˆæˆç†Ÿ**
   - Spring Boot ç”Ÿæ€å®Œå–„
   - RocketMQ å¯é æ€§é«˜
   - Resilience4j åŠŸèƒ½å¼ºå¤§

4. **å¯æ‰©å±•æ€§å¼º**
   - Snowflake ID æ”¯æŒåˆ†å¸ƒå¼
   - åˆ†å¸ƒå¼é”å·²å°±ç»ª
   - æ˜“äºæ°´å¹³æ‰©å±•

---

### æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

**ç«‹å³ä¿®å¤ (P0):**
1. æ·»åŠ æ•°æ®åº“ä¹è§‚é” (@Version)
2. å®‰å…¨é…ç½®åŠ å›º (ç¯å¢ƒå˜é‡)

**çŸ­æœŸæ”¹è¿› (P1, 1-2å‘¨):**
1. æ·»åŠ ç†”æ–­å™¨
2. éƒ¨ç½²è´Ÿè½½å‡è¡¡ (3å®ä¾‹)
3. ç›‘æ§ç³»ç»Ÿ (Prometheus + Grafana)

**ä¸­æœŸä¼˜åŒ– (P2, 1ä¸ªæœˆ):**
1. åˆ†åº“åˆ†è¡¨
2. è¯»å†™åˆ†ç¦»
3. å¤šçº§ç¼“å­˜

---

### æœ€ç»ˆå»ºè®®

**å¯¹äºä¸­å°å‹æ¸¸æˆå¹³å°:**
- âœ… å½“å‰ç‰ˆæœ¬ (v1.1) **å·²ç»è¶³å¤Ÿä½¿ç”¨**
- âœ… ä¼˜å…ˆå®Œæˆ P0 æ”¹è¿› (æ•°æ®åº“ä¹è§‚é”)
- âœ… æ ¹æ®å®é™…æµé‡å¢é•¿ï¼Œé€æ­¥å®æ–½ P1 å’Œ P2 æ”¹è¿›

**å¯¹äºå¤§å‹æ¸¸æˆå¹³å°:**
- âš ï¸ éœ€è¦ç«‹å³å®æ–½ P1 å’Œ P2 æ‰€æœ‰æ”¹è¿›
- âš ï¸ è€ƒè™‘ä½¿ç”¨äº‘æœåŠ¡ (AWS/é˜¿é‡Œäº‘) çš„æ‰˜ç®¡æœåŠ¡
- âš ï¸ å»ºè®®å’¨è¯¢ä¸“ä¸šçš„æ¶æ„å¸ˆè¿›è¡Œç³»ç»Ÿé‡æ„

---

## é™„å½•

### é™„å½• A: å…³é”®æ–‡ä»¶æ¸…å•

#### æ ¸å¿ƒä¸šåŠ¡æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| SlotGameService | src/main/java/com/slotgame/service/SlotGameService.java | æŠ•æ³¨æ ¸å¿ƒé€»è¾‘ |
| WalletService | src/main/java/com/slotgame/service/WalletService.java | ä½™é¢ç®¡ç† |
| RedisLock | src/main/java/com/slotgame/lock/RedisLock.java | åˆ†å¸ƒå¼é” |
| MessageProducerService | src/main/java/com/slotgame/rocketmq/producer/MessageProducerService.java | RocketMQ ç”Ÿäº§è€… |

#### é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| application.yml | src/main/resources/application.yml | åº”ç”¨é…ç½® |
| pom.xml | pom.xml | Maven ä¾èµ– |
| docker-compose.yaml | docker-compose.yaml | Docker æœåŠ¡ç¼–æ’ |
| init.sql | init.sql | æ•°æ®åº“åˆå§‹åŒ– |

---

### é™„å½• B: æ•°æ®åº“è¡¨ç»“æ„

#### users è¡¨
```sql
CREATE TABLE users (
  id BIGINT NOT NULL,
  username VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  balance DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX idx_username (username)
) ENGINE=InnoDB;
```

#### bets è¡¨
```sql
CREATE TABLE bets (
  id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  bet_amount DECIMAL(15,2) NOT NULL,
  win_amount DECIMAL(15,2) NOT NULL DEFAULT 0.00,
  result VARCHAR(500) NOT NULL,
  is_win BOOLEAN NOT NULL DEFAULT FALSE,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at),
  CONSTRAINT fk_bet_user FOREIGN KEY (user_id) REFERENCES users(id)
) ENGINE=InnoDB;
```

#### transactions è¡¨
```sql
CREATE TABLE transactions (
  id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  type VARCHAR(20) NOT NULL,
  amount DECIMAL(15,2) NOT NULL,
  balance_before DECIMAL(15,2),
  balance_after DECIMAL(15,2),
  description VARCHAR(255),
  bet_id BIGINT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  INDEX idx_user_id (user_id),
  INDEX idx_type (type),
  INDEX idx_created_at (created_at),
  CONSTRAINT fk_tx_user FOREIGN KEY (user_id) REFERENCES users(id),
  CONSTRAINT fk_tx_bet FOREIGN KEY (bet_id) REFERENCES bets(id)
) ENGINE=InnoDB;
```

---

### é™„å½• C: API ç«¯ç‚¹æ¸…å•

#### è®¤è¯ API

| ç«¯ç‚¹ | æ–¹æ³• | è®¤è¯ | é™æµ | è¯´æ˜ |
|------|------|------|------|------|
| /api/auth/register | POST | âŒ | - | æ³¨å†Œæ–°ç”¨æˆ· |
| /api/auth/login | POST | âŒ | - | ç”¨æˆ·ç™»å…¥ |
| /api/auth/logout | POST | âœ… | - | ç”¨æˆ·ç™»å‡º |

#### æ¸¸æˆ API

| ç«¯ç‚¹ | æ–¹æ³• | è®¤è¯ | é™æµ | è¯´æ˜ |
|------|------|------|------|------|
| /api/game/spin | POST | âœ… | 10/s | æŠ•æ³¨æ—‹è½¬ |
| /api/game/balance | GET | âœ… | - | æŸ¥è¯¢ä½™é¢ |

#### é’±åŒ… API

| ç«¯ç‚¹ | æ–¹æ³• | è®¤è¯ | é™æµ | è¯´æ˜ |
|------|------|------|------|------|
| /api/wallet/deposit | POST | âœ… | 5/s | å­˜æ¬¾ |
| /api/wallet/withdraw-all | POST | âœ… | 3/s | ææ¬¾ |

#### RTP ç»Ÿè®¡ API

| ç«¯ç‚¹                             | æ–¹æ³• | è®¤è¯ | é™æµ | è¯´æ˜ |
|--------------------------------|------|------|------|------|
| /api/rtp/statistics/{gameCode} | GET | âŒ | - | è·å– RTP ç»Ÿè®¡ |
| /api/rtp/reset/{gameCode}      | POST | âŒ | - | é‡ç½® RTP ç»Ÿè®¡ |

---

### é™„å½• D: ä¾èµ–ç‰ˆæœ¬æ¸…å•

```xml
<!-- æ ¸å¿ƒæ¡†æ¶ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <version>3.5.3</version>
</dependency>

<!-- æ•°æ®åº“ -->
<dependency>
    <groupId>com.mysql</groupId>
    <artifactId>mysql-connector-j</artifactId>
    <version>8.0.33</version>
</dependency>

<!-- Redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>

<!-- RocketMQ -->
<dependency>
    <groupId>org.apache.rocketmq</groupId>
    <artifactId>rocketmq-spring-boot-starter</artifactId>
    <version>2.3.0</version>
</dependency>

<!-- é™æµå™¨ -->
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-spring-boot3</artifactId>
    <version>2.1.0</version>
</dependency>

<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.12.3</version>
</dependency>

<!-- ç›‘æ§ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

---

### é™„å½• E: å‚è€ƒèµ„æ–™

1. **Spring Boot å®˜æ–¹æ–‡æ¡£**
   - https://spring.io/projects/spring-boot

2. **Resilience4j æ–‡æ¡£**
   - https://resilience4j.readme.io/

3. **RocketMQ å®˜æ–¹æ–‡æ¡£**
   - https://rocketmq.apache.org/

4. **Redis åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ**
   - https://redis.io/docs/manual/patterns/distributed-locks/

5. **ShardingSphere åˆ†åº“åˆ†è¡¨**
   - https://shardingsphere.apache.org/

---

**æŠ¥å‘Šç»“æŸ**

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»é¡¹ç›®è´Ÿè´£äººã€‚
